<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src 'unsafe-inline' vscode-resource:; script-src 'unsafe-inline' vscode-resource:;">
    <title>Gemini API Key Aggregator Dashboard</title>
    <style>
        :root {
            --vscode-font-family: var(--vscode-font-family);
            --vscode-font-size: var(--vscode-font-size);
            --vscode-foreground: var(--vscode-foreground);
            --vscode-background: var(--vscode-editor-background);
            --vscode-button-background: var(--vscode-button-background);
            --vscode-button-foreground: var(--vscode-button-foreground);
            --vscode-button-hoverBackground: var(--vscode-button-hoverBackground);
            --vscode-input-background: var(--vscode-input-background);
            --vscode-input-border: var(--vscode-input-border);
            --vscode-input-foreground: var(--vscode-input-foreground);
            --vscode-list-hoverBackground: var(--vscode-list-hoverBackground);
            --vscode-panel-border: var(--vscode-panel-border);
            --success-color: #4CAF50;
            --warning-color: #FF9800;
            --error-color: #F44336;
            --info-color: #2196F3;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--vscode-font-family);
            font-size: var(--vscode-font-size);
            color: var(--vscode-foreground);
            background-color: var(--vscode-background);
            line-height: 1.6;
            padding: 12px;
            margin: 0;
            overflow-x: hidden;
        }

        .dashboard {
            width: 100%;
            margin: 0;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--vscode-panel-border);
        }

        .header h1 {
            font-size: 1.4em;
            margin-bottom: 6px;
        }

        .header .subtitle {
            opacity: 0.8;
            font-size: 1.1em;
        }

        .stats-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--vscode-input-background);
            border: 1px solid var(--vscode-input-border);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            background: var(--vscode-list-hoverBackground);
        }

        .stat-card .icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card .label {
            opacity: 0.8;
            font-size: 0.9em;
        }

        .stat-card.success .value { color: var(--success-color); }
        .stat-card.warning .value { color: var(--warning-color); }
        .stat-card.error .value { color: var(--error-color); }
        .stat-card.info .value { color: var(--info-color); }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--vscode-panel-border);
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--vscode-foreground);
            font-family: inherit;
            font-size: inherit;
            transition: background-color 0.2s ease;
        }

        .tab:hover {
            background: var(--vscode-list-hoverBackground);
        }

        .tab.active {
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            background: var(--vscode-input-background);
            border: 1px solid var(--vscode-input-border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-title {
            font-size: 1.3em;
            font-weight: bold;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: inherit;
            transition: background-color 0.2s ease;
        }

        .btn-primary {
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
        }

        .btn-primary:hover {
            background: var(--vscode-button-hoverBackground);
        }

        .btn-secondary {
            background: transparent;
            color: var(--vscode-foreground);
            border: 1px solid var(--vscode-input-border);
        }

        .btn-secondary:hover {
            background: var(--vscode-list-hoverBackground);
        }

        .btn-danger {
            background: var(--error-color);
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--vscode-panel-border);
        }

        .table th {
            font-weight: bold;
            background: var(--vscode-list-hoverBackground);
        }

        .table tr:hover {
            background: var(--vscode-list-hoverBackground);
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-active { background: var(--success-color); color: white; }
        .status-inactive { background: var(--warning-color); color: white; }
        .status-error { background: var(--error-color); color: white; }
        .status-cooling { background: var(--info-color); color: white; }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--vscode-input-border);
            border-radius: 4px;
            background: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            font-family: inherit;
            font-size: inherit;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--vscode-button-background);
        }

        .actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--vscode-input-border);
            border-radius: 50%;
            border-top-color: var(--vscode-button-background);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: var(--vscode-background);
            margin: 15% auto;
            padding: 20px;
            border: 1px solid var(--vscode-panel-border);
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            color: var(--vscode-foreground);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            opacity: 0.7;
        }

        .server-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .proxy-mode-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: var(--vscode-input-border);
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .toggle-switch.active {
            background: var(--success-color);
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(26px);
        }

        .chart-container {
            height: 200px;
            margin: 20px 0;
            background: var(--vscode-list-hoverBackground);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--vscode-foreground);
            opacity: 0.7;
        }

        .proxy-mode-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--vscode-panel-border);
        }

        .proxy-mode-section h3 {
            margin-bottom: 15px;
            font-size: 1.1em;
            font-weight: bold;
        }

        .proxy-mode-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .proxy-mode-option {
            border: 1px solid var(--vscode-input-border);
            border-radius: 8px;
            padding: 15px;
            transition: all 0.2s ease;
        }

        .proxy-mode-option:hover {
            background: var(--vscode-list-hoverBackground);
            border-color: var(--vscode-button-background);
        }

        .radio-label {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            cursor: pointer;
            margin: 0;
        }

        .radio-custom {
            width: 20px;
            height: 20px;
            border: 2px solid var(--vscode-input-border);
            border-radius: 50%;
            position: relative;
            flex-shrink: 0;
            margin-top: 2px;
            transition: all 0.2s ease;
        }

        .radio-custom::after {
            content: '';
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--vscode-button-background);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.2s ease;
        }

        input[type="radio"] {
            display: none;
        }

        input[type="radio"]:checked + .radio-custom {
            border-color: var(--vscode-button-background);
        }

        input[type="radio"]:checked + .radio-custom::after {
            transform: translate(-50%, -50%) scale(1);
        }

        .mode-info {
            flex: 1;
        }

        .mode-info strong {
            display: block;
            margin-bottom: 5px;
            font-size: 1.05em;
        }

        .mode-info p {
            margin: 0;
            opacity: 0.8;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .rotating-proxy-config {
            background: var(--vscode-list-hoverBackground);
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
        }

        .rotating-proxy-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .help-text {
            display: block;
            margin-top: 5px;
            font-size: 0.8em;
            opacity: 0.7;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>🔑 Gemini API Key Aggregator</h1>
            <p class="subtitle">Manage your API keys, proxies, and monitor server performance</p>
        </div>

        <!-- Statistics Overview -->
        <div class="stats-grid">
            <div class="stat-card success">
                <div class="icon">🟢</div>
                <div class="value" id="server-status">Stopped</div>
                <div class="label">Server Status</div>
            </div>
            <div class="stat-card info">
                <div class="icon">🔑</div>
                <div class="value" id="api-keys-count">0</div>
                <div class="label">API Keys</div>
            </div>
            <div class="stat-card info">
                <div class="icon">🌐</div>
                <div class="value" id="proxies-count">0</div>
                <div class="label">Proxies</div>
            </div>
            <div class="stat-card warning">
                <div class="icon">📊</div>
                <div class="value" id="total-requests">0</div>
                <div class="label">Total Requests</div>
            </div>
        </div>

        <!-- Server Controls -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Server Control</h2>
                <div class="server-controls">
                    <button class="btn btn-primary" id="start-server">Start Server</button>
                    <button class="btn btn-secondary" id="stop-server">Stop Server</button>
                    <button class="btn btn-secondary" id="restart-server">Restart Server</button>
                </div>
            </div>

            <!-- Proxy Mode Configuration -->
            <div class="proxy-mode-section">
                <h3>Proxy Assignment Mode</h3>
                <div class="proxy-mode-options">
                    <div class="proxy-mode-option">
                        <label class="radio-label">
                            <input type="radio" name="proxy-mode" value="dedicated" id="mode-dedicated" checked>
                            <span class="radio-custom"></span>
                            <div class="mode-info">
                                <strong>🎯 Dedicated Assignment (Recommended)</strong>
                                <p>Each API key gets its own assigned proxy for better performance and rate limit isolation.</p>
                            </div>
                        </label>
                    </div>

                    <div class="proxy-mode-option">
                        <label class="radio-label">
                            <input type="radio" name="proxy-mode" value="rotating" id="mode-rotating">
                            <span class="radio-custom"></span>
                            <div class="mode-info">
                                <strong>🔄 Rotating Proxy Mode</strong>
                                <p>All API keys share a single rotating proxy endpoint that provides different IPs per request.</p>
                            </div>
                        </label>
                    </div>

                    <div class="proxy-mode-option">
                        <label class="radio-label">
                            <input type="radio" name="proxy-mode" value="pool" id="mode-pool">
                            <span class="radio-custom"></span>
                            <div class="mode-info">
                                <strong>🌊 Pool Rotation (Legacy)</strong>
                                <p>All API keys share proxies from the pool in rotation - simpler but less optimal.</p>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Rotating Proxy Configuration -->
                <div class="rotating-proxy-config" id="rotating-proxy-config" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Rotating Proxy URL</label>
                        <input type="text" class="form-input" id="rotating-proxy-url"
                               placeholder="http://username-rotate:password@proxy.example.com:8080">
                        <small class="help-text">Use credentials with "-rotate" suffix for automatic IP rotation</small>
                    </div>
                    <div class="rotating-proxy-status">
                        <span class="status-badge" id="rotating-proxy-status">Not Configured</span>
                        <button class="btn btn-secondary" id="test-rotating-proxy">Test Connection</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="api-keys">API Keys</button>
            <button class="tab" data-tab="proxies">Proxies</button>
            <button class="tab" data-tab="analytics">Analytics</button>
            <button class="tab" data-tab="settings">Settings</button>
        </div>

        <!-- API Keys Tab -->
        <div class="tab-content active" id="api-keys">
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">API Keys Management</h2>
                    <button class="btn btn-primary" id="add-api-key">Add API Key</button>
                </div>
                <table class="table" id="api-keys-table">
                    <thead>
                        <tr>
                            <th>Key ID</th>
                            <th>Status</th>
                            <th>Requests</th>
                            <th>Last Used</th>
                            <th>Proxy</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- API keys will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Proxies Tab -->
        <div class="tab-content" id="proxies">
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Proxy Management</h2>
                    <button class="btn btn-primary" id="add-proxy">Add Proxy</button>
                </div>
                <table class="table" id="proxies-table">
                    <thead>
                        <tr>
                            <th>Proxy URL</th>
                            <th>Status</th>
                            <th>Assigned Keys</th>
                            <th>Response Time</th>
                            <th>Last Check</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Proxies will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div class="tab-content" id="analytics">
            <div class="section">
                <h2 class="section-title">Performance Analytics</h2>
                <div class="chart-container">
                    📈 Request Rate Chart (Coming Soon)
                </div>
                <div class="chart-container">
                    🎯 Success Rate Chart (Coming Soon)
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div class="tab-content" id="settings">
            <div class="section">
                <h2 class="section-title">Configuration</h2>
                <div class="form-group">
                    <label class="form-label">Server Port</label>
                    <input type="number" class="form-input" id="server-port" placeholder="3000">
                </div>
                <div class="form-group">
                    <label class="form-label">Request Timeout (ms)</label>
                    <input type="number" class="form-input" id="request-timeout" placeholder="30000">
                </div>
                <div class="form-group">
                    <label class="form-label">Max Concurrent Requests</label>
                    <input type="number" class="form-input" id="max-concurrent" placeholder="10">
                </div>
                <button class="btn btn-primary" id="save-settings">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="add-api-key-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add API Key</h3>
                <span class="close" data-modal="add-api-key-modal">&times;</span>
            </div>
            <div class="form-group">
                <label class="form-label">API Key</label>
                <input type="password" class="form-input" id="new-api-key" placeholder="AIza...">
            </div>
            <div class="actions">
                <button class="btn btn-primary" id="confirm-add-api-key">Add Key</button>
                <button class="btn btn-secondary" data-modal="add-api-key-modal">Cancel</button>
            </div>
        </div>
    </div>

    <div id="add-proxy-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Proxy</h3>
                <span class="close" data-modal="add-proxy-modal">&times;</span>
            </div>
            <div class="form-group">
                <label class="form-label">Proxy URL</label>
                <input type="text" class="form-input" id="new-proxy-url" placeholder="http://username:password@proxy.example.com:8080">
            </div>
            <div class="actions">
                <button class="btn btn-primary" id="confirm-add-proxy">Add Proxy</button>
                <button class="btn btn-secondary" data-modal="add-proxy-modal">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // VS Code API
        const vscode = acquireVsCodeApi();

        // Tab functionality
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                
                // Update active tab
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Update active content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabName).classList.add('active');
            });
        });

        // Modal functionality
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Close modal when clicking outside or on close button
        document.querySelectorAll('.close, [data-modal]').forEach(element => {
            element.addEventListener('click', (e) => {
                const modalId = e.target.dataset.modal || e.target.closest('[data-modal]')?.dataset.modal;
                if (modalId) {
                    closeModal(modalId);
                }
            });
        });

        // Server controls
        document.getElementById('start-server').addEventListener('click', () => {
            vscode.postMessage({ command: 'startServer' });
        });

        document.getElementById('stop-server').addEventListener('click', () => {
            vscode.postMessage({ command: 'stopServer' });
        });

        document.getElementById('restart-server').addEventListener('click', () => {
            vscode.postMessage({ command: 'restartServer' });
        });

        // Proxy mode selection
        document.querySelectorAll('input[name="proxy-mode"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const mode = e.target.value;
                const rotatingConfig = document.getElementById('rotating-proxy-config');

                // Show/hide rotating proxy configuration
                if (mode === 'rotating') {
                    rotatingConfig.style.display = 'block';
                } else {
                    rotatingConfig.style.display = 'none';
                }

                // Send mode change to extension
                vscode.postMessage({
                    command: 'setProxyAssignmentMode',
                    mode: mode
                });
            });
        });

        // Test rotating proxy
        document.getElementById('test-rotating-proxy').addEventListener('click', () => {
            const url = document.getElementById('rotating-proxy-url').value;
            if (url) {
                vscode.postMessage({
                    command: 'testRotatingProxy',
                    url: url
                });
            } else {
                alert('Please enter a rotating proxy URL first');
            }
        });

        // API Key management
        document.getElementById('add-api-key').addEventListener('click', () => {
            openModal('add-api-key-modal');
        });

        document.getElementById('confirm-add-api-key').addEventListener('click', () => {
            const apiKey = document.getElementById('new-api-key').value;
            if (apiKey) {
                vscode.postMessage({ command: 'addApiKey', apiKey });
                document.getElementById('new-api-key').value = '';
                closeModal('add-api-key-modal');
            }
        });

        // Proxy management
        document.getElementById('add-proxy').addEventListener('click', () => {
            openModal('add-proxy-modal');
        });

        document.getElementById('confirm-add-proxy').addEventListener('click', () => {
            const proxyUrl = document.getElementById('new-proxy-url').value;
            if (proxyUrl) {
                vscode.postMessage({ command: 'addProxy', proxyUrl });
                document.getElementById('new-proxy-url').value = '';
                closeModal('add-proxy-modal');
            }
        });

        // Settings
        document.getElementById('save-settings').addEventListener('click', () => {
            const settings = {
                port: document.getElementById('server-port').value,
                timeout: document.getElementById('request-timeout').value,
                maxConcurrent: document.getElementById('max-concurrent').value
            };
            vscode.postMessage({ command: 'saveSettings', settings });
        });

        // Listen for messages from extension
        window.addEventListener('message', event => {
            const message = event.data;

            switch (message.command) {
                case 'updateStats':
                    updateStats(message.data);
                    break;
                case 'updateApiKeys':
                    updateApiKeysTable(message.data);
                    break;
                case 'updateProxies':
                    updateProxiesTable(message.data);
                    break;
                case 'updateServerStatus':
                    updateServerStatus(message.data);
                    break;
                case 'rotatingProxyTestResult':
                    updateRotatingProxyTestResult(message.success, message.message);
                    break;
                case 'updateProxyMode':
                    updateProxyMode(message.data);
                    break;
            }
        });

        function updateStats(data) {
            document.getElementById('server-status').textContent = data.serverRunning ? 'Running' : 'Stopped';
            document.getElementById('api-keys-count').textContent = data.apiKeysCount || 0;
            document.getElementById('proxies-count').textContent = data.proxiesCount || 0;
            document.getElementById('total-requests').textContent = data.totalRequests || 0;
        }

        function updateApiKeysTable(apiKeys) {
            const tbody = document.querySelector('#api-keys-table tbody');
            tbody.innerHTML = '';
            
            apiKeys.forEach(key => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${key.keyId}</td>
                    <td><span class="status-badge status-${key.status}">${key.status}</span></td>
                    <td>${key.currentRequests || 0}</td>
                    <td>${key.lastUsed ? new Date(key.lastUsed).toLocaleString() : 'Never'}</td>
                    <td>${key.proxy || 'None'}</td>
                    <td class="actions">
                        <button class="btn btn-secondary" onclick="editApiKey('${key.keyId}')">Edit</button>
                        <button class="btn btn-danger" onclick="deleteApiKey('${key.keyId}')">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateProxiesTable(proxies) {
            const tbody = document.querySelector('#proxies-table tbody');
            tbody.innerHTML = '';
            
            proxies.forEach(proxy => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${proxy.url}</td>
                    <td><span class="status-badge status-${proxy.status}">${proxy.status}</span></td>
                    <td>${proxy.assignedKeys || 0}</td>
                    <td>${proxy.responseTime ? proxy.responseTime + 'ms' : 'N/A'}</td>
                    <td>${proxy.lastCheck ? new Date(proxy.lastCheck).toLocaleString() : 'Never'}</td>
                    <td class="actions">
                        <button class="btn btn-secondary" onclick="testProxy('${proxy.id}')">Test</button>
                        <button class="btn btn-danger" onclick="deleteProxy('${proxy.id}')">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateServerStatus(status) {
            const serverStatusElement = document.getElementById('server-status');
            serverStatusElement.textContent = status.isRunning ? 'Running' : 'Stopped';

            const card = serverStatusElement.closest('.stat-card');
            card.className = 'stat-card ' + (status.isRunning ? 'success' : 'warning');
        }

        function updateRotatingProxyTestResult(success, message) {
            const statusElement = document.getElementById('rotating-proxy-status');
            if (success) {
                statusElement.className = 'status-badge status-active';
                statusElement.textContent = 'Connected';
            } else {
                statusElement.className = 'status-badge status-error';
                statusElement.textContent = 'Failed';
            }

            // Show a temporary message
            const messageDiv = document.createElement('div');
            messageDiv.className = success ? 'success-message' : 'error-message';
            messageDiv.textContent = message;
            messageDiv.style.cssText = `
                margin-top: 10px;
                padding: 8px 12px;
                border-radius: 4px;
                font-size: 0.9em;
                background: ${success ? 'var(--success-color)' : 'var(--error-color)'};
                color: white;
            `;

            const configSection = document.getElementById('rotating-proxy-config');
            configSection.appendChild(messageDiv);

            // Remove message after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 5000);
        }

        function updateProxyMode(data) {
            // Update the selected proxy mode
            const modeRadios = document.querySelectorAll('input[name="proxy-mode"]');
            modeRadios.forEach(radio => {
                if (radio.value === data.mode) {
                    radio.checked = true;
                    // Trigger change event to show/hide rotating proxy config
                    radio.dispatchEvent(new Event('change'));
                }
            });

            // Update rotating proxy URL if provided
            if (data.rotatingProxyUrl) {
                document.getElementById('rotating-proxy-url').value = data.rotatingProxyUrl;
            }

            // Update rotating proxy status
            if (data.rotatingProxyStatus) {
                const statusElement = document.getElementById('rotating-proxy-status');
                statusElement.className = `status-badge status-${data.rotatingProxyStatus.toLowerCase()}`;
                statusElement.textContent = data.rotatingProxyStatus;
            }
        }

        // Action functions
        function editApiKey(keyId) {
            vscode.postMessage({ command: 'editApiKey', keyId });
        }

        function deleteApiKey(keyId) {
            if (confirm('Are you sure you want to delete this API key?')) {
                vscode.postMessage({ command: 'deleteApiKey', keyId });
            }
        }

        function testProxy(proxyId) {
            vscode.postMessage({ command: 'testProxy', proxyId });
        }

        function deleteProxy(proxyId) {
            if (confirm('Are you sure you want to delete this proxy?')) {
                vscode.postMessage({ command: 'deleteProxy', proxyId });
            }
        }

        // Request initial data
        vscode.postMessage({ command: 'requestInitialData' });
    </script>
</body>
</html>
